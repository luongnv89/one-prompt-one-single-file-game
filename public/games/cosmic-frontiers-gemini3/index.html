<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cosmic Frontiers: The Chronos Engine</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background-color: #050505;
            font-family: 'Courier New', Courier, monospace;
            color: #00ffcc;
            user-select: none;
        }
        canvas {
            display: block;
        }
        #ui-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none; /* Let clicks pass to canvas usually */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 20px;
            box-sizing: border-box;
        }
        .hud-top {
            display: flex;
            justify-content: space-between;
            font-size: 20px;
            text-shadow: 0 0 10px #00ffcc;
        }
        .health-bar-container {
            width: 200px;
            height: 20px;
            border: 2px solid #00ffcc;
            background: rgba(0,0,0,0.5);
        }
        .health-bar-fill {
            width: 100%;
            height: 100%;
            background: #00ffcc;
            transition: width 0.2s;
        }
        #message-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            pointer-events: auto;
            z-index: 10;
        }
        h1 {
            font-size: 48px;
            margin-bottom: 10px;
            color: #fff;
            text-shadow: 0 0 20px #00aaff;
        }
        h2 { color: #ff0055; text-shadow: 0 0 10px #ff0055; }
        p { max-width: 600px; line-height: 1.6; font-size: 18px; color: #ddd; margin-bottom: 30px; }
        button {
            background: transparent;
            border: 2px solid #00ffcc;
            color: #00ffcc;
            padding: 15px 40px;
            font-size: 24px;
            font-family: inherit;
            cursor: pointer;
            transition: all 0.3s;
            margin: 10px;
            text-shadow: 0 0 5px #00ffcc;
            box-shadow: 0 0 10px rgba(0, 255, 204, 0.2);
        }
        button:hover {
            background: #00ffcc;
            color: #000;
            box-shadow: 0 0 20px #00ffcc;
        }
        .btn-bad {
            border-color: #ff0055;
            color: #ff0055;
            text-shadow: 0 0 5px #ff0055;
        }
        .btn-bad:hover {
            background: #ff0055;
            color: #fff;
            box-shadow: 0 0 20px #ff0055;
        }
        .hidden { display: none !important; }
        .anomaly-text { color: #ae00ff; text-shadow: 0 0 10px #ae00ff; animation: glitch 0.5s infinite; }
        @keyframes glitch {
            0% { transform: translate(0,0); }
            25% { transform: translate(2px,2px); }
            50% { transform: translate(-2px,-2px); }
            75% { transform: translate(2px,-2px); }
            100% { transform: translate(0,0); }
        }
    </style>
</head>
<body>

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <!-- HUD -->
    <div id="ui-layer">
        <div class="hud-top">
            <div>SCORE: <span id="scoreEl">0</span></div>
            <div>
                HULL INTEGRITY
                <div class="health-bar-container">
                    <div class="health-bar-fill" id="healthEl"></div>
                </div>
            </div>
        </div>
        <div id="level-indicator" style="text-align: center; font-size: 14px; opacity: 0.7;"></div>
    </div>

    <!-- Screens -->
    <div id="message-overlay">
        <div id="start-screen">
            <h1>COSMIC FRONTIERS</h1>
            <p>Year 2347. You are Commander Elara Vance.</p>
            <p>Your Mission: Navigate the Kepler Expanse, survive the Obsidian Nebula, and secure the Chronos Engine in the Nexus before the Kryll Hegemony does.</p>
            <button onclick="game.startLevel(1)">INITIATE LAUNCH</button>
        </div>

        <div id="level-screen" class="hidden">
            <h2 id="level-title">LEVEL TITLE</h2>
            <p id="level-desc">Description...</p>
            <button onclick="game.resume()">ENGAGE</button>
        </div>

        <div id="game-over-screen" class="hidden">
            <h2 style="color: #ff3333">MISSION FAILED</h2>
            <p>The Kryll have destroyed your vessel. The Chronos Engine is lost.</p>
            <button onclick="location.reload()">REBOOT SYSTEM</button>
        </div>

        <div id="victory-screen" class="hidden">
            <h1 style="color:#ffee00">CHRONOS ENGINE SECURED</h1>
            <p>The Kryll Warlord is defeated. The Engine pulsates with raw temporal energy. You must decide its fate.</p>
            <div style="display: flex; justify-content: center;">
                <button onclick="game.endGame(1)">THE GUARDIAN<br><span style="font-size:14px">Form a Council. Protect the Galaxy.</span></button>
                <button class="btn-bad" onclick="game.endGame(2)">THE CONQUEROR<br><span style="font-size:14px">Seize the power. Rule Time.</span></button>
            </div>
        </div>

        <div id="ending-screen" class="hidden">
            <h1 id="end-title"></h1>
            <p id="end-desc"></p>
            <button onclick="location.reload()">PLAY AGAIN</button>
        </div>
    </div>

<script>
/**
 * COSMIC FRONTIERS - GAME ENGINE
 */

const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// Responsive Canvas
function resize() {
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
}
window.addEventListener('resize', resize);
resize();

// Input Handling
const keys = { ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false, w: false, a: false, s: false, d: false, " ": false };
window.addEventListener('keydown', e => keys[e.key] = true);
window.addEventListener('keyup', e => keys[e.key] = false);

// Utility
function dist(x1, y1, x2, y2) { return Math.sqrt((x2-x1)**2 + (y2-y1)**2); }
function rand(min, max) { return Math.random() * (max - min) + min; }

// --- Game Classes ---

class Particle {
    constructor(x, y, color, speed) {
        this.x = x;
        this.y = y;
        this.vx = (Math.random() - 0.5) * speed;
        this.vy = (Math.random() - 0.5) * speed;
        this.life = 1.0;
        this.color = color;
        this.decay = rand(0.02, 0.05);
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        this.life -= this.decay;
    }
    draw() {
        ctx.globalAlpha = this.life;
        ctx.fillStyle = this.color;
        ctx.beginPath();
        ctx.arc(this.x, this.y, 2, 0, Math.PI*2);
        ctx.fill();
        ctx.globalAlpha = 1;
    }
}

class Star {
    constructor() {
        this.reset();
    }
    reset() {
        this.x = rand(0, canvas.width);
        this.y = rand(0, canvas.height);
        this.size = rand(0.5, 2);
        this.speed = rand(0.1, 0.5); // Parallax effect
    }
    update(speedMult) {
        this.y += this.speed * speedMult;
        if (this.y > canvas.height) {
            this.y = 0;
            this.x = rand(0, canvas.width);
        }
    }
    draw() {
        ctx.fillStyle = "#ffffff";
        ctx.globalAlpha = rand(0.5, 1);
        ctx.fillRect(this.x, this.y, this.size, this.size);
        ctx.globalAlpha = 1;
    }
}

class Bullet {
    constructor(x, y, angle, isEnemy = false) {
        this.x = x;
        this.y = y;
        this.speed = 10;
        this.vx = Math.cos(angle) * this.speed;
        this.vy = Math.sin(angle) * this.speed;
        this.isEnemy = isEnemy;
        this.active = true;
        this.radius = 4;
    }
    update() {
        this.x += this.vx;
        this.y += this.vy;
        // Cull out of bounds
        if (this.x < 0 || this.x > canvas.width || this.y < 0 || this.y > canvas.height) {
            this.active = false;
        }
    }
    draw() {
        ctx.save();
        ctx.fillStyle = this.isEnemy ? '#ff0055' : '#00ffcc';
        ctx.shadowBlur = 10;
        ctx.shadowColor = ctx.fillStyle;
        ctx.beginPath();
        ctx.arc(this.x, this.y, this.radius, 0, Math.PI*2);
        ctx.fill();
        ctx.restore();
    }
}

class Entity {
    constructor(x, y, r, hp, speed) {
        this.x = x;
        this.y = y;
        this.radius = r;
        this.hp = hp;
        this.maxHp = hp;
        this.speed = speed;
        this.active = true;
        this.rotation = -Math.PI/2;
    }
}

class Player extends Entity {
    constructor() {
        super(canvas.width/2, canvas.height - 100, 15, 100, 5);
        this.shootTimer = 0;
    }
    update() {
        // Movement
        if (keys.ArrowUp || keys.w) this.y -= this.speed;
        if (keys.ArrowDown || keys.s) this.y += this.speed;
        if (keys.ArrowLeft || keys.a) this.x -= this.speed;
        if (keys.ArrowRight || keys.d) this.x += this.speed;

        // Boundaries
        this.x = Math.max(this.radius, Math.min(canvas.width - this.radius, this.x));
        this.y = Math.max(this.radius, Math.min(canvas.height - this.radius, this.y));

        // Shooting
        if (this.shootTimer > 0) this.shootTimer--;
        if (keys[" "] && this.shootTimer <= 0) {
            game.bullets.push(new Bullet(this.x, this.y - 20, -Math.PI/2, false));
            this.shootTimer = 15; // Fire rate
        }
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        
        // Draw Ship
        ctx.fillStyle = '#000';
        ctx.strokeStyle = '#00ffcc';
        ctx.lineWidth = 2;
        ctx.shadowBlur = 15;
        ctx.shadowColor = '#00ffcc';
        
        ctx.beginPath();
        ctx.moveTo(0, -20); // Nose
        ctx.lineTo(15, 15);
        ctx.lineTo(0, 10);
        ctx.lineTo(-15, 15);
        ctx.closePath();
        ctx.fill();
        ctx.stroke();

        // Engine flame
        ctx.fillStyle = `rgba(0, 255, 255, ${rand(0.5, 1)})`;
        ctx.shadowBlur = 0;
        ctx.beginPath();
        ctx.moveTo(-5, 15);
        ctx.lineTo(0, 25);
        ctx.lineTo(5, 15);
        ctx.fill();

        ctx.restore();
    }
}

class Enemy extends Entity {
    constructor(type, x, y) {
        // Types: 1=Asteroid/Drone, 2=Kryll Fighter, 3=Boss
        let hp = type === 1 ? 10 : (type === 2 ? 30 : 500);
        let r = type === 1 ? 20 : (type === 2 ? 25 : 60);
        let s = type === 1 ? 2 : (type === 2 ? 3 : 1);
        super(x, y, r, hp, s);
        this.type = type;
        this.moveTimer = 0;
    }
    update() {
        this.y += this.speed * game.timeDilation; // Move down generally

        if (this.type === 2) { // Kryll Fighter AI
            // Sway logic
            this.x += Math.sin(Date.now() / 500) * 2;
            // Shoot
            if (Math.random() < 0.02) {
                let angle = Math.atan2(game.player.y - this.y, game.player.x - this.x);
                game.bullets.push(new Bullet(this.x, this.y, angle, true));
            }
        } 
        else if (this.type === 3) { // Boss
            // Hover at top
            if (this.y < 150) this.y += 1;
            else {
                this.x += Math.sin(Date.now() / 1000) * 3; // Side to side
            }
            // Boss patterns
            if (Math.random() < 0.05) {
                // Spread shot
                for(let i=-2; i<=2; i++) {
                     game.bullets.push(new Bullet(this.x, this.y, Math.PI/2 + (i*0.2), true));
                }
            }
        }

        if (this.y > canvas.height + 50) this.active = false;
    }
    draw() {
        ctx.save();
        ctx.translate(this.x, this.y);
        if (game.currentLevel === 2) {
            // Glitch effect in Obsidian Nebula
            if(Math.random() < 0.1) ctx.translate(rand(-5,5), 0);
        }

        ctx.shadowBlur = 10;
        
        if (this.type === 1) {
            // Asteroid / Drone
            ctx.strokeStyle = '#aaa';
            ctx.shadowColor = '#fff';
            ctx.beginPath();
            ctx.arc(0,0, this.radius, 0, Math.PI*2);
            ctx.stroke();
        } else if (this.type === 2) {
            // Kryll Fighter
            ctx.strokeStyle = '#ff0055';
            ctx.fillStyle = '#330011';
            ctx.shadowColor = '#ff0055';
            ctx.beginPath();
            ctx.moveTo(0, 20);
            ctx.lineTo(20, -10);
            ctx.lineTo(-20, -10);
            ctx.closePath();
            ctx.fill();
            ctx.stroke();
        } else if (this.type === 3) {
            // Boss
            ctx.strokeStyle = '#ae00ff';
            ctx.fillStyle = '#110022';
            ctx.shadowColor = '#ae00ff';
            ctx.shadowBlur = 20;
            ctx.beginPath();
            ctx.arc(0,0, this.radius, 0, Math.PI*2);
            ctx.fill();
            ctx.stroke();
            // Boss Eye
            ctx.fillStyle = '#fff';
            ctx.beginPath();
            ctx.arc(0,0, 10, 0, Math.PI*2);
            ctx.fill();
        }

        ctx.restore();
    }
}

// --- Game Logic ---

class Game {
    constructor() {
        this.player = new Player();
        this.bullets = [];
        this.enemies = [];
        this.particles = [];
        this.stars = Array(50).fill().map(() => new Star());
        
        this.score = 0;
        this.state = 'START'; // START, PLAY, LEVEL_DONE, GAMEOVER, WIN
        this.currentLevel = 1;
        this.levelTimer = 0;
        this.levelDuration = 1000; // Frames
        this.spawnTimer = 0;
        this.timeDilation = 1; // For Temporal Anomaly

        // UI Elements
        this.uiScore = document.getElementById('scoreEl');
        this.uiHealth = document.getElementById('healthEl');
        this.uiLevel = document.getElementById('level-indicator');
        
        this.loop = this.loop.bind(this);
        requestAnimationFrame(this.loop);
    }

    startLevel(lvl) {
        this.currentLevel = lvl;
        this.player.hp = 100;
        this.player.x = canvas.width/2;
        this.player.y = canvas.height - 100;
        this.bullets = [];
        this.enemies = [];
        this.levelTimer = 0;
        this.timeDilation = 1;
        
        // Level Setup
        const titles = ["", "Stage 1: The Kepler Expanse", "Stage 2: The Obsidian Nebula", "Stage 3: The Chronos Nexus"];
        const descs = ["", 
            "Collect Intel (Score) by destroying automated defense drones. Build up resources for the journey ahead.", 
            "WARNING: TEMPORAL ANOMALIES DETECTED. <br>The Kryll fleet is intercepting. Time moves strangely here. Watch for distortions.", 
            "BOSS BATTLE IMMINENT. <br>The Kryll Warlord guards the Chronos Engine. Destroy the Mothership to secure the artifact."
        ];

        document.getElementById('start-screen').classList.add('hidden');
        document.getElementById('level-screen').classList.remove('hidden');
        document.getElementById('level-title').innerHTML = titles[lvl];
        document.getElementById('level-title').className = lvl === 2 ? 'anomaly-text' : '';
        document.getElementById('level-desc').innerHTML = descs[lvl];

        this.uiLevel.innerText = titles[lvl];
    }

    resume() {
        document.getElementById('level-screen').classList.add('hidden');
        this.state = 'PLAY';
    }

    spawnEnemy() {
        // Logic varies by level
        let spawnRate = 60;
        if (this.currentLevel === 2) spawnRate = 40;
        if (this.currentLevel === 3) spawnRate = 100; // Slow spawn during boss, or boss minions

        if (this.spawnTimer++ > spawnRate) {
            this.spawnTimer = 0;
            let x = rand(50, canvas.width - 50);
            
            if (this.currentLevel === 1) {
                this.enemies.push(new Enemy(1, x, -50)); // Drones
            } else if (this.currentLevel === 2) {
                this.enemies.push(new Enemy(Math.random() > 0.3 ? 2 : 1, x, -50)); // Mix
            } 
        }

        // Spawn Boss specifically for Level 3
        if (this.currentLevel === 3 && this.enemies.filter(e => e.type === 3).length === 0 && this.levelTimer > 100) {
            let boss = new Enemy(3, canvas.width/2, -100);
            this.enemies.push(boss);
        }
    }

    update() {
        if (this.state !== 'PLAY') return;

        // Level Logic
        this.levelTimer++;

        // Level 2 Temporal Anomaly: Randomly speed up or slow down game
        if (this.currentLevel === 2) {
            if (Math.random() < 0.01) this.timeDilation = rand(0.2, 2.0);
            if (Math.random() < 0.05) this.timeDilation += (1 - this.timeDilation) * 0.1; // Return to normal
        } else {
            this.timeDilation = 1;
        }

        // Background
        this.stars.forEach(s => s.update(this.currentLevel === 2 ? this.timeDilation * 5 : 5));

        this.player.update();
        this.spawnEnemy();

        // Update Entities
        this.bullets.forEach(b => b.update());
        this.enemies.forEach(e => e.update());
        this.particles.forEach(p => p.update());

        // Collisions
        this.checkCollisions();
        
        // Cleanup
        this.bullets = this.bullets.filter(b => b.active);
        this.enemies = this.enemies.filter(e => e.active);
        this.particles = this.particles.filter(p => p.life > 0);

        // Win Conditions
        if (this.currentLevel === 1 && this.score >= 500) {
            this.startLevel(2);
        }
        if (this.currentLevel === 2 && this.score >= 1500) {
            this.startLevel(3);
        }
        if (this.currentLevel === 3) {
            // Check if boss dead (Boss logic handled in collision)
        }

        // UI Update
        this.uiHealth.style.width = `${Math.max(0, this.player.hp)}%`;
        this.uiScore.innerText = this.score;

        if (this.player.hp <= 0) {
            this.state = 'GAMEOVER';
            document.getElementById('game-over-screen').classList.remove('hidden');
        }
    }

    checkCollisions() {
        // Bullets hit Enemies
        this.bullets.forEach(b => {
            if (b.isEnemy) {
                // Enemy bullet hits player
                if (dist(b.x, b.y, this.player.x, this.player.y) < this.player.radius + b.radius) {
                    this.player.hp -= 10;
                    b.active = false;
                    this.createExplosion(b.x, b.y, '#ff0000', 5);
                }
            } else {
                // Player bullet hits enemy
                this.enemies.forEach(e => {
                    if (dist(b.x, b.y, e.x, e.y) < e.radius + b.radius) {
                        e.hp -= 20;
                        b.active = false;
                        this.createExplosion(b.x, b.y, '#00ffcc', 5);
                        if (e.hp <= 0) {
                            e.active = false;
                            this.score += e.type * 100;
                            this.createExplosion(e.x, e.y, '#ffaa00', 20);
                            
                            if (e.type === 3) { // Boss Kill
                                setTimeout(() => {
                                    this.state = 'WIN';
                                    document.getElementById('victory-screen').classList.remove('hidden');
                                }, 1000);
                            }
                        }
                    }
                });
            }
        });

        // Player hits Enemy Body
        this.enemies.forEach(e => {
            if (dist(this.player.x, this.player.y, e.x, e.y) < this.player.radius + e.radius) {
                this.player.hp -= 1; // Continuous damage
                e.hp -= 1;
                this.createExplosion((this.player.x+e.x)/2, (this.player.y+e.y)/2, '#fff', 2);
            }
        });
    }

    createExplosion(x, y, color, count) {
        for(let i=0; i<count; i++) {
            this.particles.push(new Particle(x, y, color, 3));
        }
    }

    draw() {
        // Clear
        ctx.fillStyle = '#050505';
        ctx.fillRect(0, 0, canvas.width, canvas.height);

        // Anomalous Background (Level 2)
        if (this.currentLevel === 2 && Math.random() < 0.05) {
            ctx.fillStyle = `rgba(${rand(50,100)}, 0, ${rand(50,100)}, 0.1)`;
            ctx.fillRect(0,0,canvas.width, canvas.height);
        }

        this.stars.forEach(s => s.draw());
        this.particles.forEach(p => p.draw());
        this.bullets.forEach(b => b.draw());
        this.enemies.forEach(e => e.draw());
        
        if (this.player.hp > 0) this.player.draw();
    }

    loop() {
        this.update();
        this.draw();
        requestAnimationFrame(this.loop);
    }

    endGame(choice) {
        document.getElementById('victory-screen').classList.add('hidden');
        const endScreen = document.getElementById('ending-screen');
        const endTitle = document.getElementById('end-title');
        const endDesc = document.getElementById('end-desc');
        endScreen.classList.remove('hidden');

        if (choice === 1) {
            endTitle.innerText = "ENDING: THE GUARDIAN";
            endTitle.style.color = "#00ffcc";
            endDesc.innerText = "Commander Vance establishes the Galactic Temporal Council. The Chronos Engine is sealed within a stasis field, its power studied cautiously to cure diseases and reverse planetary decay. A new era of peace begins.";
        } else {
            endTitle.innerText = "ENDING: THE CONQUEROR";
            endTitle.style.color = "#ff0055";
            endDesc.innerText = "Commander Vance harnesses the Engine. Kryll forces are wiped from existence before they ever invaded. Humanity expands aggressively, ruled by an immortal Empress who controls the flow of time itself. Freedom is a memory.";
        }
    }
}

// Init Game
const game = new Game();

</script>
</body>
</html>